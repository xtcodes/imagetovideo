<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Image → Video Converter</title>
<style>
body {
  font-family: sans-serif;
  background: #f4f8fd;
  padding: 20px;
  display: flex;
  justify-content: center;
}
.app {
  width: 100%;
  max-width: 600px;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
h2 { text-align: center; margin-bottom: 16px; }

.file-btn, .btn {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  padding: 12px 16px;
  border-radius: 8px;
  background: #2563eb;
  color: #fff;
  font-weight: 500;
  cursor: pointer;
  width: auto;       /* jangan full, otomatis pas */
  min-width: 150px;  /* minimal */
  text-align: center;
  margin-bottom: 12px;
  text-decoration: none;
  border: none;
  outline: none;
}
.file-btn:hover, .btn:hover { background: #1d4ed8; }

.preview {
  width: 100%;
  aspect-ratio: 1/1;
  background: #ddd;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 12px;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}
.preview::after {
  content: "No Image";
  color: #777;
  font-size: 16px;
  position: absolute;
}
.preview img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: none; /* default disembunyikan */
}

.range-container, .quality-container, .format-container { margin-bottom: 12px; }
.progress-container { display: none; margin-top: 12px; }
.progress { height: 20px; background: #eee; border-radius: 99px; overflow: hidden; position: relative; }
.fill { height: 100%; width: 0; background: linear-gradient(90deg,#2563eb,#3b82f6); }
.progress-text { position: absolute; top: 50%; left: 10px; transform: translateY(-50%); font-size: 14px; font-weight: 500; }
</style>
</head>
<body>
<div class="app">
<h2>Image → Video Converter</h2>

<button class="file-btn" id="uploadBtn">Pilih Gambar</button>
<input type="file" id="fileInput" accept="image/*" style="display:none;">

<div class="preview"><img id="preview" alt="preview"></div>

<div class="range-container">
  <label>Durasi (detik, max 60)</label><br>
  <input type="range" id="durationRange" min="1" max="60" value="10">
  <span id="durVal">10 detik</span>
</div>

<div class="quality-container">
  <label>Kualitas Video:</label><br>
  <select id="qualitySelect">
    <option value="720">HD (720p)</option>
    <option value="1080" selected>Full HD (1080p)</option>
    <option value="2160">4K (2160p)</option>
  </select>
</div>

<div class="format-container">
  <label>Format Output:</label><br>
  <select id="formatSelect">
    <option value="mp4" selected>MP4 (H.264)</option>
    <option value="webm">WebM (VP9)</option>
    <option value="gif">GIF</option>
  </select>
</div>

<button class="btn" id="startBtn" style="display:none;">Buat Video</button>

<div class="progress-container">
  <div class="progress">
    <div class="fill" id="fill"></div>
    <div class="progress-text" id="progressText">0%</div>
  </div>
</div>

<a id="download" class="btn" download style="display:none;">Unduh</a>
<canvas id="canvas" style="display:none"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
<script>
const { createFFmpeg } = FFmpeg;
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const previewBox = document.querySelector('.preview');
const durationRange = document.getElementById('durationRange');
const durVal = document.getElementById('durVal');
const qualitySelect = document.getElementById('qualitySelect');
const formatSelect = document.getElementById('formatSelect');
const startBtn = document.getElementById('startBtn');
const fill = document.getElementById('fill');
const progressText = document.getElementById('progressText');
const progressContainer = document.querySelector('.progress-container');
const download = document.getElementById('download');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let img = null;

// Tombol upload
uploadBtn.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);

  // tampilkan preview <img>
  preview.src = url;
  preview.style.display = "block";
  previewBox.classList.remove('placeholder');
  previewBox.style.background = "#0000"; // hapus abu-abu
  previewBox.querySelector("::after"); // hilangkan teks "No Image"

  // untuk canvas
  img = new Image();
  img.onload = () => {
    startBtn.style.display = "inline-flex";
  };
  img.src = url;

  uploadBtn.textContent = f.name;
  download.style.display = "none";
  progressContainer.style.display = "none";
  fill.style.width = "0%";
  progressText.textContent = "0%";
});

// slider durasi
durationRange.addEventListener('input', () => {
  durVal.textContent = durationRange.value + " detik";
});

function drawImageSquareWithBlur() {
  const cw = canvas.width, ch = canvas.height;
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, cw, ch);
  if (!img || img.naturalWidth === 0) return;

  const iw = img.naturalWidth, ih = img.naturalHeight;
  const scale = Math.min(cw / iw, ch / ih);
  const dw = iw * scale, dh = ih * scale;
  const dx = (cw - dw) / 2, dy = (ch - dh) / 2;

  ctx.save();
  ctx.filter = 'blur(40px)';
  ctx.drawImage(img, 0, 0, cw, ch);
  ctx.restore();

  ctx.drawImage(img, dx, dy, dw, dh);
}

async function createVideo() {
  if (!img || img.naturalWidth === 0) {
    alert("Pilih gambar dulu!");
    return;
  }
  const durationSec = Math.min(60, Math.max(1, Number(durationRange.value)));
  const size = Number(qualitySelect.value);
  const format = formatSelect.value;

  canvas.width = size;
  canvas.height = size;

  startBtn.style.display = "none";
  progressContainer.style.display = "block";
  fill.style.width = "0%";
  progressText.textContent = "0%";
  download.style.display = "none";

  const fps = 30;
  const stream = canvas.captureStream(fps);
  let chunks = [];
  const recorder = new MediaRecorder(stream, { mimeType:"video/webm;codecs=vp9", videoBitsPerSecond: 8_000_000 });
  recorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
  recorder.start();

  const start = performance.now();
  function loop(now) {
    drawImageSquareWithBlur();
    const pct = Math.min(1, (now - start) / (durationSec * 1000));
    fill.style.width = (pct*100) + "%";
    progressText.textContent = Math.floor(pct*100) + "%";
    if (pct < 1) requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  await new Promise(r => setTimeout(r, durationSec*1000));
  recorder.stop();
  await new Promise(r => recorder.onstop = r);

  const blob = new Blob(chunks, { type: "video/webm" });
  const webmData = new Uint8Array(await blob.arrayBuffer());

  let finalBlob, filename;
  if (format === "webm") {
    finalBlob = blob;
    filename = `output_${size}p.webm`;
  } else {
    const ffmpeg = createFFmpeg({ log: true });
    await ffmpeg.load();
    ffmpeg.FS('writeFile', 'input.webm', webmData);

    if (format === "mp4") {
      await ffmpeg.run('-i', 'input.webm', '-c:v', 'libx264', '-crf', '18', '-preset', 'veryfast', 'output.mp4');
      const data = ffmpeg.FS('readFile', 'output.mp4');
      finalBlob = new Blob([data.buffer], { type: 'video/mp4' });
      filename = `output_${size}p.mp4`;
    } else if (format === "gif") {
      await ffmpeg.run('-i', 'input.webm', '-vf', 'fps=15,scale=480:-1:flags=lanczos', 'output.gif');
      const data = ffmpeg.FS('readFile', 'output.gif');
      finalBlob = new Blob([data.buffer], { type: 'image/gif' });
      filename = `output.gif`;
    }
  }

  const url = URL.createObjectURL(finalBlob);
  download.href = url;
  download.download = filename;

  progressContainer.style.display = "none";
  download.style.display = "inline-flex";
}
startBtn.addEventListener('click', createVideo);
</script>
</body>
</html>
