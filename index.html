<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Image → Video Converter (HD + Format)</title>
<style>
  body { font-family:sans-serif; background:#f4f8fd; padding:20px; display:flex; justify-content:center; }
  .app { width:100%; max-width:720px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.08); }
  h2 { text-align:center; margin-bottom:14px; }
  .file-btn, .btn {
    display:inline-flex; align-items:center; justify-content:center;
    width:100%; padding:12px; border-radius:8px; background:#2563eb; color:#fff;
    font-weight:600; border:none; cursor:pointer; margin-bottom:12px;
  }
  .file-btn:hover, .btn:hover { background:#1d4ed8; }
  .preview {
    width:100%; aspect-ratio:1/1; border-radius:8px; background:#eee; margin-bottom:12px;
    display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
  }
  .preview::after { content:"No Image"; color:#666; font-size:14px; position:absolute; }
  .preview.has-image::after { content:""; }
  .preview img { max-width:100%; max-height:100%; object-fit:contain; display:none; }
  .row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px; }
  select, input[type=range] { width:100%; }
  label { font-size:13px; color:#333; }
  .progress-container { display:none; margin-top:12px; }
  .progress { height:20px; background:#eee; border-radius:99px; position:relative; overflow:hidden; }
  .fill { height:100%; width:0; background:linear-gradient(90deg,#2563eb,#3b82f6); }
  .progress-text { position:absolute; left:10px; top:50%; transform:translateY(-50%); font-weight:600; font-size:13px; }
</style>
</head>
<body>
<div class="app">
  <h2>Image → Video Converter</h2>

  <button class="file-btn" id="uploadBtn">Pilih Gambar</button>
  <input type="file" id="fileInput" accept="image/*" style="display:none">

  <div class="preview" id="previewBox"><img id="previewImg" alt="Preview"></div>

  <div class="row">
    <div style="flex:1">
      <label>Durasi (detik)</label>
      <input type="range" id="durationRange" min="1" max="60" value="10">
      <span id="durVal">10 detik</span>
    </div>
    <div style="flex:1">
      <label>Kualitas</label>
      <select id="qualitySelect">
        <option value="720">720p</option>
        <option value="1080" selected>1080p</option>
        <option value="2160">4K</option>
      </select>
    </div>
    <div style="flex:1">
      <label>Format</label>
      <select id="formatSelect">
        <option value="webm">WebM</option>
        <option value="mp4" selected>MP4</option>
        <option value="gif">GIF</option>
      </select>
    </div>
  </div>

  <button class="btn" id="startBtn" style="display:none">Buat Video</button>

  <div class="progress-container" id="progressContainer">
    <div class="progress">
      <div class="fill" id="fill"></div>
      <div class="progress-text" id="progressText">0%</div>
    </div>
  </div>

  <a id="downloadBtn" class="btn" download style="display:none">Unduh</a>

  <canvas id="canvas" style="display:none"></canvas>
</div>

<!-- ffmpeg.wasm (untuk mp4/gif) -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<script>
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const previewBox = document.getElementById('previewBox');
const previewImg = document.getElementById('previewImg');
const durationRange = document.getElementById('durationRange');
const durVal = document.getElementById('durVal');
const qualitySelect = document.getElementById('qualitySelect');
const formatSelect = document.getElementById('formatSelect');
const startBtn = document.getElementById('startBtn');
const progressContainer = document.getElementById('progressContainer');
const fill = document.getElementById('fill');
const progressText = document.getElementById('progressText');
const downloadBtn = document.getElementById('downloadBtn');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let img = null;

// Upload
uploadBtn.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);

  previewImg.src = url;
  previewImg.onload = () => {
    previewImg.style.display = "block";
    previewBox.classList.add("has-image");
    startBtn.style.display = "block";
    img = new Image();
    img.src = url;
  };
});

// Durasi slider
durationRange.addEventListener('input', () => {
  durVal.textContent = durationRange.value + " detik";
});

// Draw image ke canvas
function drawImage(size) {
  canvas.width = size;
  canvas.height = size;
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, size, size);

  if (!img) return;
  const iw = img.naturalWidth;
  const ih = img.naturalHeight;
  const scale = Math.min(size / iw, size / ih);
  const dw = iw * scale;
  const dh = ih * scale;
  const dx = (size - dw) / 2;
  const dy = (size - dh) / 2;

  ctx.save();
  ctx.filter = 'blur(30px)';
  ctx.drawImage(img, 0, 0, size, size);
  ctx.restore();

  ctx.drawImage(img, dx, dy, dw, dh);
}

// Cari codec
function getMime() {
  if (MediaRecorder.isTypeSupported("video/webm;codecs=vp9")) return "video/webm;codecs=vp9";
  if (MediaRecorder.isTypeSupported("video/webm;codecs=vp8")) return "video/webm;codecs=vp8";
  return "video/webm";
}

// Buat video
startBtn.addEventListener('click', async () => {
  if (!img) { alert("Pilih gambar dulu!"); return; }

  const durationSec = Number(durationRange.value);
  const size = Number(qualitySelect.value);
  const format = formatSelect.value;

  startBtn.style.display = "none";
  progressContainer.style.display = "block";
  fill.style.width = "0%";
  progressText.textContent = "0%";

  drawImage(size);
  const stream = canvas.captureStream(30);
  const mimeType = getMime();
  let chunks = [];
  const recorder = new MediaRecorder(stream, { mimeType });
  recorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
  recorder.start();

  const start = performance.now();
  function loop(now) {
    drawImage(size);
    const pct = Math.min(1, (now - start) / (durationSec*1000));
    fill.style.width = (pct*100) + "%";
    progressText.textContent = Math.floor(pct*100) + "%";
    if (pct < 1) requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  await new Promise(r => setTimeout(r, durationSec*1000));
  recorder.stop();
  await new Promise(r => recorder.onstop = r);

  const webmBlob = new Blob(chunks, { type: mimeType });

  // Kalau WebM langsung download
  if (format === "webm") {
    const url = URL.createObjectURL(webmBlob);
    downloadBtn.href = url;
    downloadBtn.download = "output.webm";
    downloadBtn.style.display = "block";
    return;
  }

  // MP4/GIF pakai ffmpeg.wasm
  const { createFFmpeg } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });
  await ffmpeg.load();
  ffmpeg.FS('writeFile', 'input.webm', new Uint8Array(await webmBlob.arrayBuffer()));

  if (format === "mp4") {
    await ffmpeg.run('-i', 'input.webm', '-c:v', 'libx264', '-preset', 'veryfast', 'output.mp4');
    const out = ffmpeg.FS('readFile', 'output.mp4');
    const mp4Blob = new Blob([out.buffer], { type: 'video/mp4' });
    const url = URL.createObjectURL(mp4Blob);
    downloadBtn.href = url;
    downloadBtn.download = "output.mp4";
    downloadBtn.style.display = "block";
  } else if (format === "gif") {
    await ffmpeg.run('-i', 'input.webm', '-vf', 'fps=15,scale=480:-1:flags=lanczos', 'output.gif');
    const out = ffmpeg.FS('readFile', 'output.gif');
    const gifBlob = new Blob([out.buffer], { type: 'image/gif' });
    const url = URL.createObjectURL(gifBlob);
    downloadBtn.href = url;
    downloadBtn.download = "output.gif";
    downloadBtn.style.display = "block";
  }
});
</script>
</body>
</html>
